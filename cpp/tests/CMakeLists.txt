cmake_minimum_required(VERSION 3.16)
project(robotick_core_workloads_tests)

# ========================
# ✅ Enable CTest + Warnings
# ========================

enable_testing()

# Enforce strict compilation for test quality
add_compile_options(-Wall -Wextra -Werror)

# ========================
# ✅ Catch2 (Test Framework)
# ========================

set(CMAKE_FIND_PACKAGE_PREFER_CONFIG ON)
find_package(Catch2 3 CONFIG)

if (Catch2_FOUND)
    message(STATUS "✅ Found Catch2: ${Catch2_DIR}")
else()
    message(FATAL_ERROR "❌ Catch2 v3 not found. Please install it:\n"
                        "    sudo apt install catch2")
endif()


# ========================
# ✅ Test Sources & Target
# ========================

# Automatically discover test .cpp files
file(GLOB_RECURSE ROBOTICK_TEST_SOURCES
  CONFIGURE_DEPENDS
  ${CMAKE_CURRENT_SOURCE_DIR}/*.test.cpp
)

# Build test executable
add_executable(robotick_core_workloads_tests ${ROBOTICK_TEST_SOURCES})

# Link against core framework and Catch2
target_link_libraries(robotick_core_workloads_tests
  PUBLIC
    robotick-core-workloads
    robotick-engine
    Catch2::Catch2WithMain
)

# Link against curl lib (for WebServer testing)
target_link_libraries(robotick_core_workloads_tests PRIVATE curl)

# ✅ Re-enable exceptions just for test target
target_compile_options(robotick_core_workloads_tests PRIVATE -fexceptions)

target_compile_definitions(robotick_core_workloads_tests PRIVATE ROBOTICK_ENABLE_PYTHON=1)
target_compile_definitions(robotick_core_workloads_tests PRIVATE ROBOTICK_TEST_MODE=1)
target_compile_definitions(robotick_core_workloads_tests PRIVATE CATCH_CONFIG_ENABLE_EXCEPTIONS)

# Discover Catch2 TEST_CASEs automatically
include(Catch)
catch_discover_tests(robotick_core_workloads_tests)

# Ensure robotick-core-workloads is built before running tests
add_dependencies(robotick_core_workloads_tests robotick-core-workloads)

# ========================
# ✅ Runtime DLL Copy (for VS Code / Debugging)
# ========================

add_custom_command(TARGET robotick_core_workloads_tests POST_BUILD
  COMMAND ${CMAKE_COMMAND} -E copy_if_different
    $<TARGET_FILE:robotick-core-workloads>
    $<TARGET_FILE_DIR:robotick_core_workloads_tests>
)

